CMAKE_MINIMUM_REQUIRED(VERSION 3.0)

INCLUDE(ExternalProject)

SET(PYDS_INSTALL_PREFIX ${CMAKE_SOURCE_DIR}/output)
SET(PYDS_DEFAULT_ARGS
        "-DCMAKE_PREFIX_PATH:PATH=${PYDS_INSTALL_PREFIX};${CMAKE_PREFIX_PATH}"
        "-DCMAKE_INSTALL_PREFIX:PATH=${PYDS_INSTALL_PREFIX}"
        "-DPYTHON_SITE_PACKAGES:PATH=${PYDS_INSTALL_PREFIX}/lib/site-packages/")

SET(j2534_source "${CMAKE_CURRENT_SOURCE_DIR}/deps/j2534")
SET(j2534_build "${CMAKE_CURRENT_BINARY_DIR}/deps/j2534")
EXTERNALPROJECT_ADD(j2534 SOURCE_DIR ${j2534_source} BINARY_DIR ${j2534_build} CMAKE_CACHE_ARGS ${PYDS_DEFAULT_ARGS})

SET(uds_source "${CMAKE_CURRENT_SOURCE_DIR}/deps/uds")
SET(uds_build "${CMAKE_CURRENT_BINARY_DIR}/deps/uds")
EXTERNALPROJECT_ADD(uds SOURCE_DIR ${uds_source} BINARY_DIR ${uds_build} CMAKE_CACHE_ARGS ${PYDS_DEFAULT_ARGS} DEPENDS j2534)

FIND_PROGRAM(PYTHON "python")

if (PYTHON)
    SET(MODULE_PY   "${CMAKE_CURRENT_SOURCE_DIR}/deps/ids")
    SET(MODULE_PY_OUTPUT      "${MODULE_PY}/build/lib/ids.py")
    STRING(REGEX REPLACE "\\/" "\\\\" MODULE_PY_PREFIX ${PYDS_INSTALL_PREFIX} )

    ADD_CUSTOM_COMMAND(OUTPUT ${MODULE_PY_OUTPUT}
            WORKING_DIRECTORY ${MODULE_PY}
            COMMAND ${PYTHON} setup.py build
            COMMAND ${CMAKE_COMMAND} -E env "PYTHONPATH=${MODULE_PY_PREFIX}/lib/site-packages/"
            ${PYTHON} setup.py install --prefix=${MODULE_PY_PREFIX}
            DEPENDS ${MODULE_PY}/ids.py)

    ADD_CUSTOM_TARGET(target ALL DEPENDS ${MODULE_PY_OUTPUT})
endif()